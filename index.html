<!DOCTYPE html>
<html lang="en" class="mobile-optimized">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, shrink-to-fit=no, viewport-fit=cover">
    <title>Mobile Flu Tracker</title>
    
    <!-- Optimized Mobile CSS -->
    <link rel="stylesheet" href="https://www.w3schools.com/lib/w3-mobile.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    
    <style>
        :root {
            --safe-area-top: max(env(safe-area-inset-top), 20px);
            --safe-area-bottom: env(safe-area-inset-bottom);
            --primary-color: #00695c;
        }
        
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-overflow-scrolling: touch;
            box-sizing: border-box;
        }
        
        body, html {
            height: 100%;
            font-family: "Lato", -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f8f9fa;
            color: #333;
            margin: 0;
            padding: var(--safe-area-top) 0 var(--safe-area-bottom) 0;
        }

        /* Mobile-first layout */
        .mobile-container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0 12px;
            height: calc(100% - 56px);
        }

        /* Optimized map container */
        #mobile-map {
            height: 60vh;
            min-height: 300px;
            width: 100%;
            margin: 16px 0;
            border-radius: 12px;
            overflow: hidden;
            touch-action: pan-x pan-y;
        }

        /* Mobile-optimized controls */
        .mobile-button {
            padding: 14px 20px;
            font-size: 16px;
            border-radius: 8px;
            width: 100%;
            -webkit-appearance: none;
            touch-action: manipulation;
        }

        /* Mobile menu adjustments */
        .w3-bar {
            padding-top: var(--safe-area-top) !important;
        }
        
        .w3-bar-item {
            padding: 12px !important;
        }
    </style>
</head>

<body>
    <!-- Mobile Navigation -->
    <div class="w3-top w3-mobile">
        <div class="w3-bar w3-teal w3-card">
            <button class="w3-bar-item w3-button w3-hover-white w3-right" onclick="toggleMobileMenu()" aria-label="Menu">
                <i class="fa fa-bars"></i>
            </button>
            <span class="w3-bar-item w3-wide">Flu Tracker</span>
        </div>
    </div>

    <!-- Mobile Menu -->
    <div id="mobileMenu" class="w3-bar-block w3-white w3-hide" style="margin-top:56px;">
        <a href="#tracker" class="w3-bar-item w3-button" onclick="toggleMobileMenu()">Tracker</a>
        <a href="#prevention" class="w3-bar-item w3-button" onclick="toggleMobileMenu()">Prevention</a>
        <a href="#data" class="w3-bar-item w3-button" onclick="toggleMobileMenu()">Data</a>
    </div>

    <!-- Main Content -->
    <div class="mobile-container">
        <!-- Map Section -->
        <div id="tracker" class="w3-padding">
            <h2 class="w3-center"><i class="fa fa-map-marker-alt"></i> Live Outbreak Map</h2>
            <div id="mobile-map">
                <div class="w3-center w3-padding-16" id="mapLoading">
                    <div class="w3-spin w3-text-teal">
                        <i class="fa fa-spinner fa-2x"></i>
                    </div>
                    <p>Loading map...</p>
                </div>
            </div>
            
            <!-- Location Controls -->
            <div class="w3-padding-16">
                <div class="w3-row-padding mobile-stack">
                    <div class="w3-half w3-margin-bottom">
                        <button class="mobile-button w3-teal" onclick="getMobileLocation()" id="locateButton">
                            <i class="fa fa-location-arrow"></i> Current Location
                        </button>
                    </div>
                    <div class="w3-half">
                        <div class="w3-row">
                            <div class="w3-col s8">
                                <input type="text" class="w3-input w3-border" 
                                       id="mobileSearch" placeholder="Search location" 
                                       aria-label="Search location">
                            </div>
                            <div class="w3-col s4">
                                <button class="mobile-button w3-teal" onclick="searchMobileLocation()" id="searchButton">
                                    <i class="fa fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Risk Assessment -->
            <div id="riskAssessment" class="w3-panel" aria-live="polite"></div>
        </div>

        <!-- Prevention Section -->
        <div id="prevention" class="w3-padding-16 w3-hide">
            <!-- Prevention content -->
        </div>

        <!-- Data Section -->
        <div id="data" class="w3-padding-16 w3-hide">
            <!-- Data content -->
        </div>
    </div>

    <!-- Mobile-optimized Leaflet -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Debugged Mobile JavaScript -->
    <script>
        // Mobile Configuration
        const MOBILE_CONFIG = {
            map: {
                initialZoom: 2,
                mobileZoom: 6,
                tileLayer: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                detectRetina: true,
                maxZoom: 18,
                minZoom: 2
            },
            geolocation: {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            },
            nominatim: {
                endpoint: 'https://nominatim.openstreetmap.org/search',
                format: 'json',
                limit: 1
            }
        };

        // Mobile State Management
        let mobileMap = null;
        let mobileMarkers = [];
        let currentPosition = null;
        let isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

        // Initialize mobile app after DOM and Leaflet load
        function initMobileApp() {
            if (typeof L === 'undefined') {
                setTimeout(initMobileApp, 100);
                return;
            }
            
            try {
                initMobileMap();
                setupMobileEvents();
                loadInitialData();
                updateMapHeight();
            } catch (error) {
                console.error('Initialization error:', error);
                showMobileMessage('Failed to initialize app', 'error');
            }
        }

        // Map initialization with error handling
        function initMobileMap() {
            try {
                mobileMap = L.map('mobile-map', {
                    zoomControl: false,
                    touchZoom: true,
                    scrollWheelZoom: false,
                    doubleClickZoom: false,
                    boxZoom: false,
                    attributionControl: false
                }).setView([20, 0], MOBILE_CONFIG.map.initialZoom);

                L.tileLayer(MOBILE_CONFIG.map.tileLayer, {
                    maxZoom: MOBILE_CONFIG.map.maxZoom,
                    minZoom: MOBILE_CONFIG.map.minZoom,
                    detectRetina: MOBILE_CONFIG.map.detectRetina
                }).addTo(mobileMap);

                // Mobile-specific controls
                L.control.zoom({
                    position: 'bottomright'
                }).addTo(mobileMap);

                // Hide loading spinner
                document.getElementById('mapLoading').style.display = 'none';
            } catch (error) {
                document.getElementById('mapLoading').innerHTML = 
                    '<div class="w3-panel w3-red">Error loading map</div>';
                throw error;
            }
        }

        // Geolocation with proper error handling
        async function getMobileLocation() {
            const button = document.getElementById('locateButton');
            button.disabled = true;
            
            try {
                if (!navigator.geolocation) throw new Error('Geolocation not supported');
                
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, MOBILE_CONFIG.geolocation);
                });
                
                currentPosition = position.coords;
                updateMobileMap(currentPosition);
                button.disabled = false;
            } catch (error) {
                handleMobileGeoError(error);
                button.disabled = false;
            }
        }

        // Update map view with bounds checking
        function updateMobileMap(coords) {
            const zoomLevel = isMobile ? MOBILE_CONFIG.map.mobileZoom : MOBILE_CONFIG.map.initialZoom;
            const newView = [coords.latitude, coords.longitude];
            
            if (!mobileMap.getBounds().contains(newView)) {
                mobileMap.setView(newView, zoomLevel);
            }
            
            if (currentPosition.marker) {
                mobileMap.removeLayer(currentPosition.marker);
            }
            
            currentPosition.marker = L.marker(newView, {
                icon: L.divIcon({
                    className: 'mobile-marker',
                    html: '<i class="fa fa-user"></i>',
                    iconSize: [32, 32]
                })
            }).addTo(mobileMap);
        }

        // Handle geolocation errors
        function handleMobileGeoError(error) {
            const messages = {
                1: 'Please enable location permissions in settings',
                2: 'Location unavailable - try again later',
                3: 'Location request timed out'
            };
            showMobileMessage(messages[error.code] || 'Location error', 'error');
        }

        // Search functionality with rate limiting
        const searchMobileLocation = throttle(async () => {
            const input = document.getElementById('mobileSearch');
            const button = document.getElementById('searchButton');
            if (!input.value.trim()) return;

            button.disabled = true;
            try {
                const response = await fetch(
                    `${MOBILE_CONFIG.nominatim.endpoint}?` +
                    new URLSearchParams({
                        q: input.value,
                        format: MOBILE_CONFIG.nominatim.format,
                        limit: MOBILE_CONFIG.nominatim.limit
                    }),
                    {
                        headers: {
                            'User-Agent': 'MobileFluTracker/1.0 (iOS)'
                        }
                    }
                );
                
                if (!response.ok) throw new Error('Search failed');
                const data = await response.json();
                
                if (data.length > 0) {
                    const coords = {
                        latitude: parseFloat(data[0].lat),
                        longitude: parseFloat(data[0].lon)
                    };
                    updateMobileMap(coords);
                } else {
                    showMobileMessage('Location not found', 'warning');
                }
            } catch (error) {
                showMobileMessage('Search failed - try again', 'error');
            } finally {
                button.disabled = false;
            }
        }, 1000);

        // Mobile UI functions
        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            menu.classList.toggle('w3-show');
            
            if (menu.classList.contains('w3-show')) {
                setTimeout(() => {
                    document.addEventListener('click', function closeMenu(e) {
                        if (!menu.contains(e.target) && e.target.id !== 'mobileMenu') {
                            menu.classList.remove('w3-show');
                            document.removeEventListener('click', closeMenu);
                        }
                    });
                }, 10);
            }
        }

        // Responsive map height
        function updateMapHeight() {
            const mapElement = document.getElementById('mobile-map');
            const headerHeight = document.querySelector('.w3-top').offsetHeight;
            mapElement.style.height = `calc(100vh - ${headerHeight + 200}px)`;
        }

        // Event setup with proper cleanup
        function setupMobileEvents() {
            window.addEventListener('resize', throttle(() => {
                updateMapHeight();
                mobileMap.invalidateSize();
            }, 200));

            window.addEventListener('orientationchange', () => {
                setTimeout(() => mobileMap.invalidateSize(), 100);
            });

            document.getElementById('mobileSearch').addEventListener('input', 
                debounce(searchMobileLocation, 500)
            );
        }

        // Utility functions
        function throttle(func, limit) {
            let lastFunc, lastRan;
            return function() {
                const context = this;
                const args = arguments;
                if (!lastRan) {
                    func.apply(context, args);
                    lastRan = Date.now();
                } else {
                    clearTimeout(lastFunc);
                    lastFunc = setTimeout(() => {
                        if ((Date.now() - lastRan) >= limit) {
                            func.apply(context, args);
                            lastRan = Date.now();
                        }
                    }, limit - (Date.now() - lastRan));
                }
            };
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', initMobileApp);
    </script>
</body>
</html>
